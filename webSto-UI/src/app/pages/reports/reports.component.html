<div class="container-fluid mt--7">
  <div class="row">
    <div class="col-xl-9 mb-5 mb-xl-0">
      <div class="card shadow">
        <div class="card-header border-0">
          <app-loading-bar [isLoading]="isLoading || isDownloading"></app-loading-bar>
          <div class="row">
            <div class="col">
              <h3 class="mb-0">
                Отчеты
              </h3>
            </div>
            <div class="col-auto">
              <button class="btn btn-sm btn-buro-green" (click)="requestReportData()"
                      [disabled]="isLoading || userService.isServiceLeaderWithRestrictedAccess()">
                Обновить
              </button>
              <button class="btn btn-sm btn-buro-green" (click)="requestReportPDF()"
                      [disabled]="isDownloading || userService.isServiceLeaderWithRestrictedAccess()">
                Выгрузить в PDF
              </button>
            </div>
          </div>

        </div>
        <div class="table-responsive">

          <ng-container *ngIf="reportType === 'executors'">
            <table class="table table-flush table-hover table-sm">
              <thead class="thead-light">
                <tr>
                  <th>Исполнитель / Заказ-наряд</th>
                  <th class="text-center">Выполнение по норме времени</th>
                  <th class="text-center">Выполнение без нормы времени</th>
                  <th class="text-center">Выручка</th>
                  <th class="text-center">Процент</th>
                  <th class="text-center">ЗП</th>
                </tr>
              </thead>
              <ng-container *ngIf="userService.isServiceLeaderWithRestrictedAccess(); else executorsBlock">
                <tbody>
                <tr>
                  <th colspan="6" class="text-muted text-center">
                    <span *ngIf="userService.isServiceLeaderWithEmptySubscription()">
                      Для просмотра отчетов необходимо оформить тариф. Список тарифов доступен в соответсвующем пункте меню.
                    </span>
                    <span *ngIf="userService.isServiceLeaderWithInvalidBalance()">
                      Для просмотра отчетов необходимо пополнить баланс.
                    </span>
                  </th>
                </tr>
                </tbody>
              </ng-container>
              <ng-template #executorsBlock>
                <tbody>
                <ng-container *ngFor="let data of reportData">
                  <tr class="font-weight-bold">
                    <td>{{data.fullName}}</td>
                    <td class="text-center">{{data.totalByNorm | number:'.2':'ru'}}</td>
                    <td class="text-center">{{data.totalByPrice | number:'.2':'ru'}}</td>
                    <td class="text-center">{{data.totalSum | number:'.2':'ru'}}</td>
                    <td class="text-center">{{data.percent}}%</td>
                    <td class="text-center">{{data.salary | number:'.2':'ru'}}</td>
                  </tr>
                  <tr *ngFor="let documents of data.executorDocumentResponses, let i = index" [attr.data-index]="i">
                    <td>&ensp;№ {{i + 1}} от {{documents.documentDate | date : 'dd.MM.yy'}}</td>
                    <td class="text-center">{{documents.totalByNorm | number:'.2':'ru'}}</td>
                    <td class="text-center">{{documents.totalByPrice | number:'.2':'ru'}}</td>
                    <td class="text-center">{{documents.totalSum | number:'.2':'ru'}}</td>
                    <td class="text-center">{{documents.percent}}%</td>
                    <td class="text-center">{{documents.salary | number:'.2':'ru'}}</td>
                  </tr>
                </ng-container>
                <tr class="font-weight-bold">
                  <td>ИТОГ</td>
                  <td class="text-center">{{executorsTotalRow.totalByNorm | number:'.2':'ru'}}</td>
                  <td class="text-center">{{executorsTotalRow.totalByPrice | number:'.2':'ru'}}</td>
                  <td class="text-center">{{executorsTotalRow.totalSum | number:'.2':'ru'}}</td>
                  <td></td>
                  <td class="text-center">{{executorsTotalRow.totalSalary | number:'.2':'ru'}}</td>
                </tr>
                </tbody>
              </ng-template>
            </table>
          </ng-container>

          <ng-container *ngIf="reportType === 'clients'">
            <table class="table table-flush table-hover table-sm">
              <thead class="thead-light">
              <tr>
                <th>Контрагент / Заказ-наряд</th>
                <th class="text-center">Сумма / Итого</th>
              </tr>
              </thead>
              <ng-container *ngIf="userService.isServiceLeaderWithRestrictedAccess(); else clientsBlock">
                <tbody>
                <tr>
                  <th colspan="8" class="text-muted text-center">
                    <span *ngIf="userService.isServiceLeaderWithEmptySubscription()">
                      Для просмотра отчетов необходимо оформить тариф. Список тарифов доступен в соответсвующем пункте меню.
                    </span>
                    <span *ngIf="userService.isServiceLeaderWithInvalidBalance()">
                      Для просмотра отчетов необходимо пополнить баланс.
                    </span>
                  </th>
                </tr>
                </tbody>
              </ng-container>
              <ng-template #clientsBlock>
                <tbody>
                <ng-container *ngFor="let data of reportData">
                  <tr class="font-weight-bold">
                    <td>{{data.fullName}}</td>
                    <td class="text-center">{{data.total | number:'.2':'ru'}}</td>
                  </tr>
                  <tr *ngFor="let documents of data.clientDocumentResponses, let i = index" [attr.data-index]="i">
                    <td>&ensp;№ {{i + 1}} от {{documents.documentDate | date : 'dd.MM.yy'}}</td>
                    <td class="text-center">{{documents.total | number:'.2':'ru'}}</td>
                  </tr>
                </ng-container>
                <tr class="font-weight-bold">
                  <td>ИТОГ</td>
                  <td class="text-center">{{clientsTotalRow.total | number:'.2':'ru'}}</td>
                </tr>
                </tbody>
              </ng-template>
            </table>
          </ng-container>

        </div>
      </div>
    </div>

    <div class="col-xl-3">
      <div class="card shadow">
        <div class="card-body">
          <h3 class="text-muted">Настройки отчетов</h3>

          <div class="form-group">
            <label class="form-control-label" for="state-select">Тип отчета</label>
            <select id="state-select" class="form-control form-control-sm form-control-alternative"
                    [disabled]="userService.isServiceLeaderWithRestrictedAccess()"
                    [(ngModel)]="reportType" (change)="requestReportData()">
              <option [selected]="reportType === 'executors'" [ngValue]="'executors'">
                Выручка по слесарям
              </option>
              <option [selected]="reportType === 'clients'" [ngValue]="'clients'">
                Отчет о реализации
              </option>
            </select>
          </div>

          <div class="form-group" *ngIf="!userService.isServiceLeader()">
            <label class="form-control-label" for="organization-select">Предприятие</label>
            <select id="organization-select" class="form-control form-control-sm form-control-alternative"
                    [disabled]="userService.isServiceLeaderWithRestrictedAccess()"
                    [(ngModel)]="organizationId" (change)="requestReportData()">
              <option [selected]="true" disabled [ngValue]="null">
                Выберите организацию
              </option>
              <option [selected]="organization.id === organizationId" *ngFor="let organization of organizations" [ngValue]="organization.id">
                {{ organization.fullName }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-control-label" for="month-select">Месяц</label>
            <select id="month-select" class="form-control form-control-sm form-control-alternative"
                    [disabled]="userService.isServiceLeaderWithRestrictedAccess()"
                    (change)="requestReportData()" [(ngModel)]="selectedMonth">
              <option [selected]="month.id === selectedMonth" *ngFor="let month of months" [ngValue]="month.id">
                {{month.name}}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-control-label" for="input-year">Год</label>
            <div class="input-group input-group-sm">
              <input type="number" id="input-year" class="form-control" placeholder="Введите год..."
                     [disabled]="userService.isServiceLeaderWithRestrictedAccess()"
                     [(ngModel)]="selectedYear" (keyup.enter)="requestReportData()">
              <div class="input-group-append">
                <button class="btn btn-buro-green" type="button"
                        [disabled]="userService.isServiceLeaderWithRestrictedAccess()" (click)="requestReportData()">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
